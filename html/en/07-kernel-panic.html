<!DOCTYPE html>
<html><head><title>Kernel Panic - Operating System in 1,000 Lines</title><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/x-icon" href="../favicon.ico"><script>
            window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
          </script><script defer="true" src="../_vercel/insights/script.js"></script><link rel="stylesheet" href="../styles.css"><meta name="generator" content="Docship (https://github.com/nuta/docship)"></head><body class="mx-auto max-w-3xl w-full py-8 px-4"><header><h1 class="text-center mb-8 text-xl font-bold">Operating System in 1,000 Lines - Kernel Panic</h1><div class="mb-8 container mx-auto flex justify-center"><ol class="w-full my-0 sm:w-fit grid grid-rows-[repeat(9,auto)] grid-flow-col gap-x-4" start="0"><li class="my-1"><a href="../en.html" class="">Intro</a></li><li class="my-1"><a href="01-setting-up-development-environment.html" class="">Getting Started</a></li><li class="my-1"><a href="02-assembly.html" class="">RISC-V 101</a></li><li class="my-1"><a href="03-overview.html" class="">Overview</a></li><li class="my-1"><a href="04-boot.html" class="">Boot</a></li><li class="my-1"><a href="05-hello-world.html" class="">Hello World!</a></li><li class="my-1"><a href="06-libc.html" class="">C Standard Library</a></li><li class="my-1"><a href="07-kernel-panic.html" class="font-bold">Kernel Panic</a></li><li class="my-1"><a href="08-exception.html" class="">Exception</a></li><li class="my-1"><a href="09-memory-allocation.html" class="">Memory Allocation</a></li><li class="my-1"><a href="10-process.html" class="">Process</a></li><li class="my-1"><a href="11-page-table.html" class="">Page Table</a></li><li class="my-1"><a href="12-application.html" class="">Application</a></li><li class="my-1"><a href="13-user-mode.html" class="">User Mode</a></li><li class="my-1"><a href="14-system-call.html" class="">System Call</a></li><li class="my-1"><a href="15-virtio-blk.html" class="">Disk I/O</a></li><li class="my-1"><a href="16-file-system.html" class="">File System</a></li><li class="my-1"><a href="17-outro.html" class="">Outro</a></li></ol></div></header><main><p>A kernel panic occurs when the kernel encounters an unrecoverable error, similar to the concept of <code>panic</code> in Go or Rust. Have you ever seen a blue screen on Windows? Let's implement the same concept in our kernel to handle fatal errors.</p>
<p>The following <code>PANIC</code> macro is the implementation of kernel panic:</p>
<pre><div class="code-block-title">kernel.h</div><code class="language-c">#<span class="pl-k">define</span> <span class="pl-en">PANIC</span>(fmt, ...)                                                        \
    <span class="pl-k">do</span> {                                                                       \
        <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>PANIC: <span class="pl-c1">%s</span>:<span class="pl-c1">%d</span>: <span class="pl-pds">"</span></span> fmt <span class="pl-s"><span class="pl-pds">"</span><span class="pl-cce">\n</span><span class="pl-pds">"</span></span>, __FILE__, __LINE__, ##__VA_ARGS__);  \
        <span class="pl-k">while</span> (<span class="pl-c1">1</span>) {}                                                           \
    } <span class="pl-k">while</span> (<span class="pl-c1">0</span>)
</code></pre>
<p>It prints where the panic occurred, it enters an infinite loop to halt processing. We define it as a macro here. The reason for this is to correctly display the source file name (<code>__FILE__</code>) and line number (<code>__LINE__</code>). If we defined this as a function, <code>__FILE__</code> and <code>__LINE__</code> would show the file name and line number where <code>PANIC</code> is defined, not where it's called.</p>
<p>This macro also uses two idioms:</p>
<p>The first idiom is the <code>do-while</code> statement. Since it's <code>while (0)</code>, this loop is only executed once. This is a common way to define macros consisting of multiple statements. Simply enclosing with <code>{ ...}</code> can lead to unintended behavior when combined with statements like <code>if</code> (see <a href="https://www.jpcert.or.jp/sc-rules/c-pre10-c.html">this clear example</a>). Also, note the backslash (<code>\</code>) at the end of each line. Although the macro is defined over multiple lines, newline characters are ignored when expanded.</p>
<p>The second idiom is <code>##__VA_ARGS__</code>. This is a useful compiler extension for defining macros that accept a variable number of arguments (reference: <a href="https://gcc.gnu.org/onlinedocs/gcc/Variadic-Macros.html">GCC documentation</a>). <code>##</code> removes the preceding <code>,</code> when the variable arguments are empty. This allows compilation to succeed even when there's only one argument, like <code>PANIC("booted!")</code>.</p>
<h2 id="lets-try-it"><a class="anchor" href="07-kernel-panic.html#lets-try-it">Let's try it</a></h2>
<p>Let's try using <code>PANIC</code>. You can use it like <code>printf</code>:</p>
<pre><div class="code-block-title">kernel.c</div><code class="language-c"><span class="pl-k">void</span> <span class="pl-en">kernel_main</span>(<span class="pl-k">void</span>) {
    <span class="pl-c1">memset</span>(__bss, <span class="pl-c1">0</span>, (<span class="pl-c1">size_t</span>) __bss_end - (<span class="pl-c1">size_t</span>) __bss);

    <span class="pl-c1">PANIC</span>(<span class="pl-s"><span class="pl-pds">"</span>booted!<span class="pl-pds">"</span></span>);
    <span class="pl-c1">printf</span>(<span class="pl-s"><span class="pl-pds">"</span>unreachable here!<span class="pl-cce">\n</span><span class="pl-pds">"</span></span>);
}
</code></pre>
<p>Try in QEMU and confirm that the correct file name and line number are displayed, and that the processing after <code>PANIC</code> is not executed (i.e., <code>"unreachable here!"</code> is not displayed):</p>
<pre><code class="language-plain">$ ./run.sh
PANIC: kernel.c:46: booted!
</code></pre>
<p>Blue screen in Windows and kernel panics in Linux are very scary, but in your own kernel, don't you think it is a nice feature to have? It's a "crash gracefully" mechanism, with a human-readable clue.</p></main><footer class="mt-8 border-t border-gray-200 py-4"><div class="container mx-auto px-4 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0 text-lg"><a href="08-exception.html">Exception ⏩</a><a href="06-libc.html" class="sm:-order-1">⏪ C Standard Library</a></div></footer></body></html>